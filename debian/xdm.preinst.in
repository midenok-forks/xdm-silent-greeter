#!/bin/sh
# Debian xdm package pre-installation script
# Copyright 1998-2001, 2003, 2004 Branden Robinson.
# Licensed under the GNU General Public License, version 2.  See the file
# /usr/share/common-licenses/GPL or <http://www.gnu.org/copyleft/gpl.txt>.
# Acknowledgements to Stephen Early, Mark Eichin, and Manoj Srivastava.

# $Id: xdm.preinst.in 189 2005-06-11 00:04:27Z branden $

set -e

THIS_PACKAGE=xdm
THIS_SCRIPT=preinst

#INCLUDE_SHELL_LIB#

if [ "$1" = "install" ] || [ "$1" = "upgrade" ]; then
  # deal with a bug in very old versions of xbase (prior to 3.3.2-1)
  if dpkg --compare-versions "$2" lt "3.3.2-1"; then
    for DIR in rc0.d rc1.d rc6.d; do
      if [ -L "/etc/$DIR/K1xdm" ]; then
        observe "fixing buggy symbolic link /etc/$DIR/K1xdm"
        mv "/etc/$DIR/K1xdm" "/etc/$DIR/K01xdm"
      fi
    done
  fi

  # as of the xfree86 4.x packages, we expect /usr/X11R6/lib/X11/xdm to be a
  # symbolic link to the /etc/X11/xdm directory; move an existing directory out
  # of the way (even if we're installing over a non-packaged XFree86
  # installation)
  if [ -e /usr/X11R6/lib/X11/xdm ] && ! [ -L /usr/X11R6/lib/X11/xdm ]; then
    observe "removing obsolete /usr/X11R6/lib/X11/xdm directory"
    mv /usr/X11R6/lib/X11/xdm /usr/X11R6/lib/X11/xdm.moved-by-preinst
  fi

  # got rid of the shared libXdmGreet in 4.0.3
  if dpkg --compare-versions "$2" lt "4.0.3-1"; then
    if update-alternatives --display xdm-greeter |
       fgrep -q /usr/X11R6/lib/libXdmGreet.so.1; then
      observe "removing obsolete xdm-greeter alternative and .so symlink"
      update-alternatives --remove xdm-greeter /usr/X11R6/lib/libXdmGreet.so.1
      # remove this garbage link that ldconfig creates
      rm -f /usr/X11R6/lib/libXdmGreet.so
    fi
  fi

  if dpkg --compare-versions "$2" lt "6.8.1-0.3"; then
    remove_conffile_prepare /etc/X11/xdm/pixmaps/XFree86.xpm 91cf8f46b31119b5d69270ae7bc5081d
    remove_conffile_prepare /etc/X11/xdm/pixmaps/XFree86bw.xpm c9ef591e6e78edd3d2352e55c0067160
  fi

  if dpkg --compare-versions "$2" lt "1:1.0.1-1"; then
    remove_conffile_prepare /etc/X11/xdm/pixmaps/debianbw.xpm c90b32c82b91d0c8c69ba5a69594a21f
    remove_conffile_prepare /etc/X11/xdm/pixmaps/debian.xpm 8bd89d6976e41f6598ab61fda364505e
    remove_conffile_prepare /etc/X11/xdm/pixmaps/xorg-bw.xpm 30e3a8767640924d5025b6995c74d8fd
    remove_conffile_prepare /etc/X11/xdm/pixmaps/xorg.xpm 97e00d725c718298a23395d11abd00a2
  fi
fi

if [ "$1" = "install" ]; then
  # Create a flag file that tells the postinst script this is an install, not
  # an upgrade.
  : >/var/run/xdm.install
fi

#DEBHELPER#

exit 0

# vim:set ai et sts=2 sw=2 tw=80:
